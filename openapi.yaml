openapi: 3.1.0
info:
  title: Linear Game Backend API
  version: 1.0.0
servers:
  - url: https://api.example.com
tags:
  - name: Health
  - name: Auth
  - name: OAuth
  - name: Workflows
  - name: Characters
  - name: Scenes
  - name: Videos
  - name: Assets
  - name: Metadata
  - name: Credits
  - name: Mock
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    WorkflowID:
      in: path
      name: workflowID
      required: true
      schema:
        type: string
        format: uuid
    CharacterID:
      in: path
      name: characterID
      required: true
      schema:
        type: string
    SceneID:
      in: path
      name: sceneID
      required: true
      schema:
        type: string
    ChapterID:
      in: path
      name: chapterID
      required: true
      schema:
        type: string
    VersionQuery:
      in: query
      name: version
      schema:
        type: integer
      description: Specific asset version to fetch; defaults to the latest or selected pointer.
    AsyncQuery:
      in: query
      name: async
      schema:
        type: boolean
      description: Return 202 Accepted and run work asynchronously when true.
    PreferAsync:
      in: header
      name: Prefer
      schema:
        type: string
        enum: ["respond-async"]
      description: Alternative to `async=1`; returns 202 Accepted and processes in the background.
    AssetTypeSelectable:
      in: path
      name: assetType
      required: true
      schema:
        type: string
        enum: [story, character_images, scene_images, first_frame_images, videos]
    JobID:
      in: path
      name: jobID
      required: true
      schema:
        type: string
        format: uuid
  responses:
    Error400:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Error401:
      description: Unauthorized or missing token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Error404:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Error413:
      description: Payload too large
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
      required: [error]
    AuthTokens:
      type: object
      properties:
        token:
          type: string
          description: Access token (Bearer JWT)
        refresh_token:
          type: string
        expires_at:
          type: string
          format: date-time
        expires_in:
          type: integer
          description: Seconds until the access token expires
      required: [token, refresh_token, expires_at, expires_in]
    WorkflowStatus:
      type: string
      enum: [pending, active, completed, failed]
    StageStatus:
      type: string
      enum: [pending, in_progress, completed, failed]
    AssetType:
      type: string
      enum: [story, plot, character_images, scene_images, first_frame_images, videos]
    VideoJobStatus:
      type: string
      enum: [queued, running, completed, failed]
    StageDetail:
      type: object
      additionalProperties: true
      description: |
        Stage metadata recorded on a workflow. Common keys include: active_stage, message, error, story_version, plot_version, character_images_version, scene_images_version, first_frame_images_version, videos_version, selected_versions, story_files, queue_position, scene_id, current_video_job_id, video_status.
    Workflow:
      type: object
      properties:
        id: {type: string, format: uuid}
        idea: {type: string}
        status: {$ref: '#/components/schemas/WorkflowStatus'}
        current_stage: {$ref: '#/components/schemas/AssetType'}
        stage_detail: {$ref: '#/components/schemas/StageDetail'}
        created_at: {type: string, format: date-time}
        updated_at: {type: string, format: date-time}
      required: [id, idea, status, current_stage, created_at, updated_at]
    WorkflowAsset:
      type: object
      properties:
        type: {$ref: '#/components/schemas/AssetType'}
        version: {type: integer}
        status: {$ref: '#/components/schemas/StageStatus'}
        summary: {type: string}
        updated_at: {type: string, format: date-time}
      required: [type, version, status, updated_at]
    AssetEnvelope:
      type: object
      properties:
        workflow: {$ref: '#/components/schemas/Workflow'}
        asset: {$ref: '#/components/schemas/WorkflowAsset'}
        credits: {$ref: '#/components/schemas/CreditUsage'}
      required: [workflow, asset]
    StoryCharacter:
      type: object
      properties:
        id: {type: string}
        name: {type: string}
        role_type: {type: string}
        player: {type: integer}
        profession: {type: string}
        profile: {type: string}
        image_prompt:
          type: string
          description: Required unless image_method is upload
        voice: {type: string}
    CharacterInput:
      allOf:
        - $ref: '#/components/schemas/StoryCharacter'
        - type: object
          required: [name, profile]
          properties:
            player:
              type: integer
              description: Optional player slot; defaults to 0.
    StoryContent:
      type: object
      properties:
        prompt: {type: string}
        language: {type: string}
        genre: {type: string}
        visual_style: {type: string}
        image_ratio: {type: string}
        story_summary: {type: string}
        characters:
          type: array
          items: {$ref: '#/components/schemas/StoryCharacter'}
      required: [prompt, language, genre, visual_style, image_ratio, story_summary, characters]
    StoryReferenceFile:
      type: object
      properties:
        name: {type: string}
        storage_key: {type: string}
        url: {type: string}
        content_type: {type: string}
        size: {type: integer}
        openai_file_id: {type: string}
    StoryAssetPayload:
      type: object
      properties:
        idea: {type: string}
        raw: {type: string, description: LLM raw response text}
        story: {$ref: '#/components/schemas/StoryContent'}
        meta:
          type: object
          properties:
            reference_files:
              type: array
              items: {$ref: '#/components/schemas/StoryReferenceFile'}
      required: [idea, raw, story]
    ImagePromptParams:
      type: object
      properties:
        description_prompt: {type: string}
        visual_style: {type: string}
        ratio: {type: string}
    ImageMethod:
      type: string
      enum: [prompt, prompt_with_references, upload]
    PlotTransitionOption:
      type: object
      properties:
        text: {type: string}
        next_scene: {type: string}
    PlotTransitionDetails:
      type: object
      properties:
        next_scene: {type: string}
        options:
          type: array
          items: {$ref: '#/components/schemas/PlotTransitionOption'}
    PlotTransition:
      type: object
      properties:
        type: {type: string}
        details: {$ref: '#/components/schemas/PlotTransitionDetails'}
    Scene:
      type: object
      properties:
        scene_id: {type: string}
        short_introduction: {type: string}
        description: {type: string}
        character_ids:
          type: array
          items: {type: string}
        image_prompt_params: {$ref: '#/components/schemas/ImagePromptParams'}
        reference_images:
          type: array
          items: {$ref: '#/components/schemas/CharacterImageReference'}
        video_motion_prompt: {type: string}
        transition_logic: {$ref: '#/components/schemas/PlotTransition'}
      required: [scene_id]
    Chapter:
      type: object
      properties:
        id: {type: string}
        title: {type: string}
        scenes:
          type: array
          items: {$ref: '#/components/schemas/Scene'}
      required: [id, scenes]
    PlotAssetPayload:
      type: object
      properties:
        raw: {type: string}
        chapters:
          type: array
          items: {$ref: '#/components/schemas/Chapter'}
        scenes:
          type: array
          items: {$ref: '#/components/schemas/Scene'}
          description: Legacy flat list; chapters is preferred.
      required: [raw, chapters]
    CharacterImageReference:
      type: object
      properties:
        name: {type: string}
        url: {type: string}
        mime_type: {type: string}
        storage_key: {type: string}
    CharacterImage:
      type: object
      properties:
        character_id: {type: string}
        name: {type: string}
        prompt: {type: string}
        url: {type: string}
        mime_type: {type: string}
        storage_key: {type: string}
        origin:
          type: string
          enum: [ai, uploaded, hybrid]
        references:
          type: array
          items: {$ref: '#/components/schemas/CharacterImageReference'}
    CharacterImageFailure:
      type: object
      properties:
        character_id: {type: string}
        name: {type: string}
        error: {type: string}
    CharacterImagesPayload:
      type: object
      properties:
        images:
          type: array
          items: {$ref: '#/components/schemas/CharacterImage'}
        failures:
          type: array
          items: {$ref: '#/components/schemas/CharacterImageFailure'}
      required: [images]
    CharacterImageHistoryEntry:
      type: object
      properties:
        version: {type: integer}
        created_at: {type: string, format: date-time}
        image: {$ref: '#/components/schemas/CharacterImage'}
      required: [version, created_at, image]
    CharacterImageHistoryResponse:
      type: object
      properties:
        entries:
          type: array
          items: {$ref: '#/components/schemas/CharacterImageHistoryEntry'}
        next_cursor: {type: integer}
    SceneImage:
      type: object
      properties:
        scene_id: {type: string}
        url: {type: string}
        mime_type: {type: string}
        prompt: {type: string}
        params: {$ref: '#/components/schemas/ImagePromptParams'}
        storage_key: {type: string}
        origin:
          type: string
          enum: [ai, uploaded, hybrid]
        references:
          type: array
          items: {$ref: '#/components/schemas/CharacterImageReference'}
    SceneImagesPayload:
      type: object
      properties:
        images:
          type: array
          items: {$ref: '#/components/schemas/SceneImage'}
      required: [images]
    SceneImageHistoryEntry:
      type: object
      properties:
        version: {type: integer}
        created_at: {type: string, format: date-time}
        image: {$ref: '#/components/schemas/SceneImage'}
      required: [version, created_at, image]
    SceneImageHistoryResponse:
      type: object
      properties:
        entries:
          type: array
          items: {$ref: '#/components/schemas/SceneImageHistoryEntry'}
        next_cursor: {type: integer}
    SceneVideo:
      type: object
      properties:
        scene_id: {type: string}
        url: {type: string}
        mime_type: {type: string}
        prompt: {type: string}
        storage_key: {type: string}
        scene_image_version: {type: integer}
        first_frame_image_version: {type: integer}
        out_of_sync: {type: boolean}
    SceneVideoFailure:
      type: object
      properties:
        scene_id: {type: string}
        prompt: {type: string}
        error: {type: string}
    SceneVideosPayload:
      type: object
      properties:
        videos:
          type: array
          items: {$ref: '#/components/schemas/SceneVideo'}
        failures:
          type: array
          items: {$ref: '#/components/schemas/SceneVideoFailure'}
      required: [videos]
    VersionItem:
      type: object
      properties:
        id: {type: string, format: uuid}
        version: {type: integer}
        status: {$ref: '#/components/schemas/StageStatus'}
        summary: {type: string}
        asset_type: {$ref: '#/components/schemas/AssetType'}
        created_at: {type: string, format: date-time}
        updated_at: {type: string, format: date-time}
      required: [id, version, status, asset_type, updated_at]
    VersionPointer:
      type: object
      properties:
        versions:
          type: array
          items: {$ref: '#/components/schemas/VersionItem'}
        selected_version:
          type: integer
          nullable: true
      required: [versions]
    StageSnapshot:
      type: object
      properties:
        asset_type: {$ref: '#/components/schemas/AssetType'}
        version: {type: integer}
        status: {$ref: '#/components/schemas/StageStatus'}
        summary: {type: string}
        updated_at: {type: string, format: date-time}
      required: [asset_type, status]
    StageAcceptedResponse:
      type: object
      properties:
        workflow: {$ref: '#/components/schemas/Workflow'}
        stage:
          type: object
          properties:
            type: {$ref: '#/components/schemas/AssetType'}
            status: {$ref: '#/components/schemas/StageStatus'}
          required: [type, status]
      required: [workflow, stage]
    StoryAssetResponse:
      allOf:
        - $ref: '#/components/schemas/AssetEnvelope'
        - type: object
          properties:
            payload: {$ref: '#/components/schemas/StoryAssetPayload'}
          required: [payload]
    PlotAssetResponse:
      allOf:
        - $ref: '#/components/schemas/AssetEnvelope'
        - type: object
          properties:
            payload: {$ref: '#/components/schemas/PlotAssetPayload'}
          required: [payload]
    CharacterImagesAssetResponse:
      allOf:
        - $ref: '#/components/schemas/AssetEnvelope'
        - type: object
          properties:
            payload: {$ref: '#/components/schemas/CharacterImagesPayload'}
          required: [payload]
    SceneImagesAssetResponse:
      allOf:
        - $ref: '#/components/schemas/AssetEnvelope'
        - type: object
          properties:
            payload: {$ref: '#/components/schemas/SceneImagesPayload'}
          required: [payload]
    SceneVideosAssetResponse:
      allOf:
        - $ref: '#/components/schemas/AssetEnvelope'
        - type: object
          properties:
            payload: {$ref: '#/components/schemas/SceneVideosPayload'}
          required: [payload]
    WorkflowListResponse:
      type: object
      properties:
        workflows:
          type: array
          items: {$ref: '#/components/schemas/Workflow'}
        next_cursor: {type: string}
      required: [workflows]
    WorkflowStatusResponse:
      type: object
      properties:
        workflow: {$ref: '#/components/schemas/Workflow'}
        stages:
          type: array
          items: {$ref: '#/components/schemas/StageSnapshot'}
      required: [workflow, stages]
    VideoJob:
      type: object
      properties:
        id: {type: string, format: uuid}
        workflow_id: {type: string, format: uuid}
        status: {$ref: '#/components/schemas/VideoJobStatus'}
        scene_id: {type: string, nullable: true}
        veo_model: {type: string}
        queue_position: {type: integer}
        started_at: {type: string, format: date-time, nullable: true}
        completed_at: {type: string, format: date-time, nullable: true}
        result_asset_id: {type: string, format: uuid, nullable: true}
        error_message: {type: string}
        credits: {$ref: '#/components/schemas/CreditUsage'}
      required: [id, workflow_id, status, veo_model, queue_position]
    SelectedVersionResponse:
      type: object
      properties:
        selected_version:
          type: integer
          nullable: true
    SubscriptionTier:
      type: string
      enum: [free, pro, ultra]
    CreditType:
      type: string
      enum: [monthly, event, top_up]
    Subscription:
      type: object
      properties:
        tier: {$ref: '#/components/schemas/SubscriptionTier'}
        auto_renew: {type: boolean}
        period_start: {type: string, format: date-time}
        period_end: {type: string, format: date-time}
      required: [tier, auto_renew, period_start, period_end]
    CreditBucket:
      type: object
      properties:
        id: {type: string, format: uuid}
        type: {$ref: '#/components/schemas/CreditType'}
        source: {type: string}
        remaining: {type: integer}
        expires_at: {type: string, format: date-time}
        period_end: {type: string, format: date-time}
      required: [id, type, remaining]
    CreditsTotals:
      type: object
      description: Totals per credit bucket type.
      additionalProperties:
        type: integer
    Credits:
      type: object
      properties:
        subscription: {$ref: '#/components/schemas/Subscription'}
        buckets:
          type: array
          items: {$ref: '#/components/schemas/CreditBucket'}
        totals: {$ref: '#/components/schemas/CreditsTotals'}
        total_available: {type: integer}
      required: [subscription, buckets, totals, total_available]
    CreditUsage:
      type: object
      properties:
        requested: {type: integer}
        processed: {type: integer}
        unit_cost: {type: integer}
        charged: {type: integer}
        shortfall: {type: integer}
        available: {type: integer}
      required: [requested, processed, unit_cost, charged]
paths:
  /healthz:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            text/plain:
              schema:
                type: string
                example: ok

  /api/v1/users/register:
    post:
      tags: [Auth]
      summary: Register with email/password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
      responses:
        '201':
          description: Auth tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          $ref: '#/components/responses/Error400'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users/login:
    post:
      tags: [Auth]
      summary: Login with email/password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password: {type: string}
      responses:
        '200':
          description: Auth tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'

  /api/v1/users/oauth/{provider}/start:
    get:
      tags: [OAuth]
      summary: Start OAuth flow
      parameters:
        - in: path
          name: provider
          required: true
          schema: {type: string, enum: [google]}
        - in: query
          name: redirect_uri
          required: true
          schema: {type: string, format: uri}
      responses:
        '302':
          description: Redirect to provider
        '400':
          $ref: '#/components/responses/Error400'
        '404':
          $ref: '#/components/responses/Error404'
        '503':
          description: OAuth provider not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users/oauth/{provider}/callback:
    get:
      tags: [OAuth]
      summary: OAuth callback
      parameters:
        - in: path
          name: provider
          required: true
          schema: {type: string, enum: [google]}
        - in: query
          name: code
          required: true
          schema: {type: string}
        - in: query
          name: state
          required: true
          schema: {type: string}
      responses:
        '302':
          description: Redirects to redirect_uri with tokens or oauth_error params
        '200':
          description: Tokens returned directly when redirect is unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          $ref: '#/components/responses/Error400'
        '404':
          $ref: '#/components/responses/Error404'
        '503':
          description: OAuth provider not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users/token/refresh:
    post:
      tags: [Auth]
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token: {type: string}
      responses:
        '200':
          description: Auth tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokens'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'

  /api/v1/users/me/credits:
    get:
      tags: [Credits]
      security: [{bearerAuth: []}]
      summary: Get subscription tier and credit balances
      responses:
        '200':
          description: Credit balances
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Credits'
        '401':
          $ref: '#/components/responses/Error401'

  /api/v1/mock/users/{userID}/subscription:
    post:
      tags: [Mock]
      summary: Mock set user subscription tier and monthly credits
      parameters:
        - in: path
          name: userID
          required: true
          schema: {type: string, format: uuid}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [tier]
              properties:
                tier: {$ref: '#/components/schemas/SubscriptionTier'}
                auto_renew: {type: boolean}
      responses:
        '200':
          description: Updated subscription and credits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Credits'
        '400':
          $ref: '#/components/responses/Error400'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/mock/users/{userID}/booster:
    post:
      tags: [Mock]
      summary: Mock grant a booster (top-up credits)
      parameters:
        - in: path
          name: userID
          required: true
          schema: {type: string, format: uuid}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [amount]
              properties:
                amount: {type: integer}
                source: {type: string}
      responses:
        '200':
          description: Updated credits after booster
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Credits'
        '400':
          $ref: '#/components/responses/Error400'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/story:
    post:
      tags: [Workflows]
      security: [{bearerAuth: []}]
      summary: Generate story and characters
      description: Idea is required when creating a new workflow; when workflow_id is provided the existing idea can be reused.
      parameters:
        - $ref: '#/components/parameters/AsyncQuery'
        - $ref: '#/components/parameters/PreferAsync'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                idea: {type: string}
                workflow_id: {type: string, format: uuid}
                story_style: {type: string}
                visual_style: {type: string}
                aspect_ratio: {type: string}
          multipart/form-data:
            schema:
              type: object
              properties:
                idea: {type: string}
                workflow_id: {type: string, format: uuid}
                story_style: {type: string}
                visual_style: {type: string}
                aspect_ratio: {type: string}
                files:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        '200':
          description: Story asset with characters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryAssetResponse'
        '202':
          description: Accepted for async processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StageAcceptedResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/scenes/{sceneID}/images/history:
    get:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: List successful scene image generations and uploads (newest first)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
        - in: query
          name: limit
          schema: {type: integer, default: 20, maximum: 100}
        - in: query
          name: cursor
          schema: {type: integer, description: Fetch entries before this asset version}
      responses:
        '200':
          description: Scene image history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneImageHistoryResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/first-frame/images:
    get:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Fetch first frame images asset
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/VersionQuery'
      responses:
        '200':
          description: First frame images asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneImagesAssetResponse'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/scenes/{sceneID}/first-frame/images:
    post:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Upload or generate a first frame image for a scene
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                description_prompt: {type: string}
                image_method: {$ref: '#/components/schemas/ImageMethod'}
          multipart/form-data:
            schema:
              type: object
              properties:
                description_prompt: {type: string}
                image_method: {$ref: '#/components/schemas/ImageMethod'}
                file:
                  type: string
                  format: binary
                references:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        '200':
          description: First frame images asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneImagesAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/scenes/{sceneID}/first-frame/images/history:
    get:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: List successful first frame image generations and uploads (newest first)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
        - in: query
          name: limit
          schema: {type: integer, default: 20, maximum: 100}
        - in: query
          name: cursor
          schema: {type: integer, description: Fetch entries before this asset version}
      responses:
        '200':
          description: First frame image history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneImageHistoryResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/plot:
    post:
      tags: [Workflows]
      security: [{bearerAuth: []}]
      summary: Generate plot and scenes (chapters default to one)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/AsyncQuery'
        - $ref: '#/components/parameters/PreferAsync'
      responses:
        '200':
          description: Plot asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlotAssetResponse'
        '202':
          description: Accepted for async processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StageAcceptedResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'
    get:
      tags: [Workflows]
      security: [{bearerAuth: []}]
      summary: Fetch plot asset
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/VersionQuery'
      responses:
        '200':
          description: Plot asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlotAssetResponse'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/characters/images:
    post:
      tags: [Characters]
      security: [{bearerAuth: []}]
      summary: Generate character images from prompts
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/AsyncQuery'
        - $ref: '#/components/parameters/PreferAsync'
      responses:
        '200':
          description: Character images asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterImagesAssetResponse'
        '202':
          description: Accepted for async processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StageAcceptedResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'
    get:
      tags: [Characters]
      security: [{bearerAuth: []}]
      summary: Fetch character images asset
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/VersionQuery'
      responses:
        '200':
          description: Character images asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterImagesAssetResponse'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/characters/{characterID}/images:
    post:
      tags: [Characters]
      security: [{bearerAuth: []}]
      summary: Regenerate a single character image (prompt or prompt + reference images)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/CharacterID'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                prompt: {type: string}
          multipart/form-data:
            schema:
              type: object
              properties:
                prompt: {type: string}
                references:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        '200':
          description: Updated character images asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterImagesAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/characters/{characterID}/images/upload:
    post:
      tags: [Characters]
      security: [{bearerAuth: []}]
      summary: Upload a character image (manual override)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/CharacterID'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
              required: [file]
      responses:
        '200':
          description: Updated character images asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterImagesAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/characters/{characterID}/images/history:
    get:
      tags: [Characters]
      security: [{bearerAuth: []}]
      summary: List successful character image generations and uploads (newest first)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/CharacterID'
        - in: query
          name: limit
          schema: {type: integer, default: 20, maximum: 100}
        - in: query
          name: cursor
          schema: {type: integer, description: Fetch entries before this asset version}
      responses:
        '200':
          description: Character image history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterImageHistoryResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/characters:
    post:
      tags: [Characters]
      security: [{bearerAuth: []}]
      summary: Add a character to the story payload
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/CharacterInput'
                - type: object
                  properties:
                    image_method: {$ref: '#/components/schemas/ImageMethod'}
                    prompt: {type: string, description: Optional prompt override when generating during creation}
          multipart/form-data:
            schema:
              type: object
              properties:
                character:
                  type: string
                  description: JSON-encoded CharacterInput
                image_method: {$ref: '#/components/schemas/ImageMethod'}
                prompt: {type: string}
                file:
                  type: string
                  format: binary
                references:
                  type: array
                  items:
                    type: string
                    format: binary
              required: [character]
      responses:
        '200':
          description: Updated story asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/characters/{characterID}:
    delete:
      tags: [Characters]
      security: [{bearerAuth: []}]
      summary: Remove a character from the story payload
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/CharacterID'
      responses:
        '200':
          description: Updated story asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/scenes/images:
    post:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Generate all scene images
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/AsyncQuery'
        - $ref: '#/components/parameters/PreferAsync'
      responses:
        '200':
          description: Scene images asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneImagesAssetResponse'
        '202':
          description: Accepted for async processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StageAcceptedResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'
    get:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Fetch scene images asset
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/VersionQuery'
      responses:
        '200':
          description: Scene images asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneImagesAssetResponse'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/scenes/{sceneID}/images:
    post:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Regenerate a specific scene image
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                description_prompt: {type: string}
                image_method: {$ref: '#/components/schemas/ImageMethod'}
          multipart/form-data:
            schema:
              type: object
              properties:
                description_prompt: {type: string}
                image_method: {$ref: '#/components/schemas/ImageMethod'}
                file:
                  type: string
                  format: binary
                references:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        '200':
          description: Updated scene images asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneImagesAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/scenes/{sceneID}/videos/upload:
    post:
      tags: [Videos]
      security: [{bearerAuth: []}]
      summary: Upload a video file for a scene
      description: Accept a single video upload (max 100MB). Uploaded videos do not capture motion prompts; the prompt field will be empty.
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Video file to attach to the scene (max 100MB).
              required: [file]
      responses:
        '200':
          description: Updated videos asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneVideosAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'
        '413':
          $ref: '#/components/responses/Error413'

  /api/v1/workflows/{workflowID}/scenes/{sceneID}/videos:
    post:
      tags: [Videos]
      security: [{bearerAuth: []}]
      summary: Regenerate a single scene video with a new motion prompt
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [prompt]
              properties:
                prompt: {type: string}
                veo_model:
                  type: string
                  enum: [veo-3.1-fast-generate-preview, veo-3.1-generate-preview]
      responses:
        '202':
          description: Video job queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoJob'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/videos:
    post:
      tags: [Videos]
      security: [{bearerAuth: []}]
      summary: Generate videos for all scenes or a specific scene
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                scene_id: {type: string}
                veo_model:
                  type: string
                  enum: [veo-3.1-fast-generate-preview, veo-3.1-generate-preview]
      responses:
        '202':
          description: Video job queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoJob'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'
    get:
      tags: [Videos]
      security: [{bearerAuth: []}]
      summary: Fetch videos asset
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/VersionQuery'
      responses:
        '200':
          description: Videos asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SceneVideosAssetResponse'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/video-jobs/{jobID}:
    get:
      tags: [Videos]
      security: [{bearerAuth: []}]
      summary: Get video job status
      parameters:
        - $ref: '#/components/parameters/JobID'
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoJob'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}:
    get:
      tags: [Workflows]
      security: [{bearerAuth: []}]
      summary: Get workflow
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      responses:
        '200':
          description: Workflow
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows:
    get:
      tags: [Workflows]
      security: [{bearerAuth: []}]
      summary: List workflows
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
        - in: query
          name: cursor
          schema: {type: string}
          description: Opaque pagination cursor returned by the previous page.
      responses:
        '200':
          description: Workflow list with cursor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowListResponse'
        '401':
          $ref: '#/components/responses/Error401'

  /api/v1/workflows/{workflowID}/story:
    get:
      tags: [Workflows]
      security: [{bearerAuth: []}]
      summary: Fetch story asset
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/VersionQuery'
      responses:
        '200':
          description: Story asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryAssetResponse'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/status:
    get:
      tags: [Workflows]
      security: [{bearerAuth: []}]
      summary: Get workflow stage/status snapshot
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      responses:
        '200':
          description: Status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowStatusResponse'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/chapters:
    post:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Add a chapter
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id: {type: string}
                title: {type: string}
      responses:
        '200':
          description: Updated plot asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlotAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/chapters/{chapterID}:
    delete:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Remove an empty chapter
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/ChapterID'
      responses:
        '200':
          description: Updated plot asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlotAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/chapters/{chapterID}/scenes:
    post:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Add a scene to a chapter at a specific index
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/ChapterID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                insert_index:
                  type: integer
                  minimum: 0
                scene:
                  $ref: '#/components/schemas/Scene'
                image_method: {$ref: '#/components/schemas/ImageMethod'}
                description_prompt:
                  type: string
                  description: Required unless image_method is upload
              required: [scene, insert_index]
          multipart/form-data:
            schema:
              type: object
              properties:
                scene:
                  type: string
                  description: JSON-encoded Scene object
                insert_index:
                  type: integer
                image_method: {$ref: '#/components/schemas/ImageMethod'}
                description_prompt:
                  type: string
                  description: Required unless image_method is upload
                file:
                  type: string
                  format: binary
                references:
                  type: array
                  items:
                    type: string
                    format: binary
              required: [scene, insert_index]
      responses:
        '200':
          description: Updated plot asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlotAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/chapters/{chapterID}/scenes/{sceneID}:
    delete:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Remove a scene (references to it are cleared)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/ChapterID'
        - $ref: '#/components/parameters/SceneID'
      responses:
        '200':
          description: Updated plot asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlotAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'
    patch:
      tags: [Scenes]
      security: [{bearerAuth: []}]
      summary: Patch a scene (supports scene_id rename; transition targets validated to chapter)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/ChapterID'
        - $ref: '#/components/parameters/SceneID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                scene_id: {type: string}
                short_introduction: {type: string}
                description: {type: string}
                character_ids:
                  type: array
                  items: {type: string}
                image_prompt_params:
                  $ref: '#/components/schemas/ImagePromptParams'
                video_motion_prompt: {type: string}
                transition_logic:
                  $ref: '#/components/schemas/PlotTransition'
      responses:
        '200':
          description: Updated plot asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlotAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/assets/{assetType}/versions:
    get:
      tags: [Assets]
      security: [{bearerAuth: []}]
      summary: List asset versions and selected pointer (story, character_images, scene_images, videos)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/AssetTypeSelectable'
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Versions list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionPointer'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/assets/{assetType}/selection:
    patch:
      tags: [Assets]
      security: [{bearerAuth: []}]
      summary: Set or clear selected asset version (no copy)
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/AssetTypeSelectable'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                version:
                  type: integer
                  nullable: true
                  description: Omit or null to clear selection.
      responses:
        '200':
          description: Selected version set
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SelectedVersionResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'

  /api/v1/workflows/{workflowID}/story/summary:
    patch:
      tags: [Workflows]
      security: [{bearerAuth: []}]
      summary: Update story summary text only
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [summary]
              properties:
                summary: {type: string}
      responses:
        '200':
          description: Updated story asset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryAssetResponse'
        '400':
          $ref: '#/components/responses/Error400'
        '401':
          $ref: '#/components/responses/Error401'
        '404':
          $ref: '#/components/responses/Error404'
