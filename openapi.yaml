openapi: 3.1.0
info:
  title: Linear Game Backend API
  description: API for Linear Game platform - story generation and workflow management
  version: 1.0.0
  contact:
    name: API Support
servers:
  - url: https://api.example.com
    description: Production server
  - url: http://localhost:8080
    description: Development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Auth
    description: Authentication and user management
  - name: OAuth
    description: OAuth authentication
  - name: Workflows
    description: Workflow management
  - name: Characters
    description: Character image generation
  - name: Scenes
    description: Scene image and video management
  - name: Videos
    description: Video generation and management
  - name: Assets
    description: Asset version management
  - name: Credits
    description: Credit balance and transactions
  - name: Payments
    description: Payment and subscription management
  - name: Webhooks
    description: External webhook handlers
  - name: Admin
    description: Administrative endpoints
  - name: Debug
    description: Debugging utilities
  - name: Mock
    description: Mock endpoints for testing

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication

  parameters:
    WorkflowID:
      in: path
      name: workflowID
      required: true
      schema:
        type: string
        format: uuid
      description: Unique workflow identifier

    CharacterID:
      in: path
      name: characterID
      required: true
      schema:
        type: string
      description: Character identifier

    SceneID:
      in: path
      name: sceneID
      required: true
      schema:
        type: string
      description: Scene identifier

    ChapterID:
      in: path
      name: chapterID
      required: true
      schema:
        type: string
      description: Chapter identifier

    AssetType:
      in: path
      name: assetType
      required: true
      schema:
        type: string
        enum:
          - story
          - plot
          - character_images
          - scene_images
          - first_frame_images
          - videos
          - publish
      description: Type of workflow asset

    UserID:
      in: path
      name: userID
      required: true
      schema:
        type: string
        format: uuid
      description: User identifier

    SessionID:
      in: path
      name: sessionID
      required: true
      schema:
        type: string
      description: Checkout session identifier

    JobID:
      in: path
      name: jobID
      required: true
      schema:
        type: string
        format: uuid
      description: Video job identifier

    InviteCodeID:
      in: path
      name: inviteCodeID
      required: true
      schema:
        type: string
        format: uuid
      description: Invite code identifier

    Limit:
      in: query
      name: limit
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      description: Maximum number of items to return

    Offset:
      in: query
      name: offset
      schema:
        type: integer
        minimum: 0
        default: 0
      description: Number of items to skip

    Cursor:
      in: query
      name: cursor
      schema:
        type: string
      description: Pagination cursor for next page

  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        google_id:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    RegisterRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        invite_code:
          type: string

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        token:
          type: string
        refresh_token:
          type: string
        user:
          $ref: '#/components/schemas/User'

    RefreshTokenRequest:
      type: object
      required:
        - refresh_token
      properties:
        refresh_token:
          type: string

    WaitlistRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email

    WorkflowStatus:
      type: string
      enum:
        - pending
        - active
        - completed
        - failed

    StageStatus:
      type: string
      enum:
        - pending
        - in_progress
        - completed
        - failed

    AssetTypeEnum:
      type: string
      enum:
        - story
        - plot
        - character_images
        - scene_images
        - first_frame_images
        - videos
        - publish

    Workflow:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        idea:
          type: string
        status:
          $ref: '#/components/schemas/WorkflowStatus'
        current_stage:
          $ref: '#/components/schemas/AssetTypeEnum'
        stage_detail:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    WorkflowAsset:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workflow_id:
          type: string
          format: uuid
        asset_type:
          $ref: '#/components/schemas/AssetTypeEnum'
        version:
          type: integer
        status:
          $ref: '#/components/schemas/StageStatus'
        summary:
          type: string
        data:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    StoryRequest:
      type: object
      required:
        - idea
      properties:
        idea:
          type: string
          description: Story idea or prompt

    VideoJobStatus:
      type: string
      enum:
        - queued
        - running
        - completed
        - failed

    VideoJob:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workflow_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/VideoJobStatus'
        scene_id:
          type: string
          nullable: true
        allowed_scenes:
          type: array
          items:
            type: object
        requested_scenes:
          type: array
          items:
            type: object
        charges:
          type: array
          items:
            type: object
        charged_amount:
          type: integer
        veo_model:
          type: string
          description: Video model (Veo or Sora).
          enum:
            - veo-3.1-fast-generate-preview
            - veo-3.1-generate-preview
            - sora-2
            - sora-2-pro
        error_message:
          type: string
        result_asset:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true

    SubscriptionTier:
      type: string
      enum:
        - free
        - pro
        - ultra

    CreditTransactionDirection:
      type: string
      enum:
        - earn
        - spend
        - expire
        - refund

    CreditTransactionType:
      type: string
      enum:
        - subscription
        - top_up
        - scene_image
        - character_image
        - first_frame
        - video
        - refund
        - expire

    CreditTransaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        direction:
          $ref: '#/components/schemas/CreditTransactionDirection'
        type:
          $ref: '#/components/schemas/CreditTransactionType'
        amount:
          type: integer
        running_balance_after:
          type: integer
        description:
          type: string
        workflow_id:
          type: string
          format: uuid
          nullable: true
        bucket_source:
          type: string
        subscription_tier:
          $ref: '#/components/schemas/SubscriptionTier'
          nullable: true
        occurred_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    CreditsResponse:
      type: object
      properties:
        total:
          type: integer
        monthly:
          type: integer
        event:
          type: integer
        top_up:
          type: integer

    CreditTransactionsResponse:
      type: object
      properties:
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/CreditTransaction'
        cursor:
          type: string
          nullable: true
        page:
          type: integer
        page_size:
          type: integer
        has_more:
          type: boolean

    SubscriptionCheckoutRequest:
      type: object
      required:
        - plan_key
      properties:
        plan_key:
          type: string
          enum:
            - pro_monthly
            - pro_annual
            - ultra_monthly
            - ultra_annual

    TopUpCheckoutRequest:
      type: object
      required:
        - package_key
      properties:
        package_key:
          type: string
          enum:
            - small
            - medium
            - large

    CheckoutResponse:
      type: object
      properties:
        session_id:
          type: string
        checkout_url:
          type: string

    InviteCodeStatus:
      type: string
      enum:
        - active
        - inactive

    InviteCode:
      type: object
      properties:
        id:
          type: string
          format: uuid
        code:
          type: string
        quota:
          type: integer
        used_count:
          type: integer
        credits_reward:
          type: integer
        status:
          $ref: '#/components/schemas/InviteCodeStatus'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateInviteCodeRequest:
      type: object
      required:
        - code
        - quota
      properties:
        code:
          type: string
        quota:
          type: integer
        credits_reward:
          type: integer
        status:
          $ref: '#/components/schemas/InviteCodeStatus'

    UpdateInviteCodeRequest:
      type: object
      properties:
        quota:
          type: integer
        credits_reward:
          type: integer
        status:
          $ref: '#/components/schemas/InviteCodeStatus'

    TransitionOption:
      type: object
      required:
        - text
        - next_scene
      properties:
        text:
          type: string
          description: Option text displayed to user
        next_scene:
          type: string
          description: Scene ID to transition to

    TransitionDetails:
      type: object
      properties:
        next_scene:
          type: string
          description: Natural next scene for linear progression
        options:
          type: array
          items:
            $ref: '#/components/schemas/TransitionOption'
          description: Branching options for non-linear transitions

    TransitionLogic:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          description: Type of transition (e.g., linear, branching)
        details:
          $ref: '#/components/schemas/TransitionDetails'

    ImagePromptPatch:
      type: object
      properties:
        description_prompt:
          type: string
          description: Image generation description prompt
        visual_style:
          type: string
          description: Visual style for the image
        ratio:
          type: string
          description: Image aspect ratio

    QTEPatch:
      type: object
      properties:
        type:
          type: string
          description: QTE type
        next_node_map:
          type: object
          additionalProperties:
            type: string
          description: Map of QTE outcomes to next scene IDs (keys must be "1", "-1", or "-2")
          example:
            "1": "scene_success"
            "-1": "scene_failure"
            "-2": "scene_timeout"

    ScenePatchRequest:
      type: object
      properties:
        scene_id:
          type: string
          description: Scene identifier
        short_introduction:
          type: string
          description: Brief introduction text for the scene
        description:
          type: string
          description: Detailed scene description
        image_prompt_params:
          $ref: '#/components/schemas/ImagePromptPatch'
        video_motion_prompt:
          type: string
          description: Motion prompt for video generation
        transition_logic:
          $ref: '#/components/schemas/TransitionLogic'
        character_ids:
          type: array
          items:
            type: string
          description: List of character IDs present in the scene
        qte:
          $ref: '#/components/schemas/QTEPatch'

    WaitlistStatus:
      type: string
      enum:
        - pending
        - approved
        - rejected

    Waitlist:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        status:
          $ref: '#/components/schemas/WaitlistStatus'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    WorkflowListResponse:
      type: object
      properties:
        workflows:
          type: array
          items:
            $ref: '#/components/schemas/Workflow'
        cursor:
          type: string
          nullable: true
        has_more:
          type: boolean

paths:
  /healthz:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns service health status
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /users/register:
    post:
      tags:
        - Auth
      summary: Register new user
      description: Create a new user account
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/login:
    post:
      tags:
        - Auth
      summary: User login
      description: Authenticate user and return JWT token
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/oauth/{provider}/start:
    get:
      tags:
        - OAuth
      summary: Start OAuth flow
      description: Initiate OAuth authentication with provider
      operationId: oauthStart
      parameters:
        - in: path
          name: provider
          required: true
          schema:
            type: string
            enum:
              - google
        - in: query
          name: redirect_uri
          schema:
            type: string
        - in: query
          name: invite_code
          schema:
            type: string
      responses:
        '302':
          description: Redirect to OAuth provider
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/oauth/{provider}/callback:
    get:
      tags:
        - OAuth
      summary: OAuth callback
      description: Handle OAuth provider callback
      operationId: oauthCallback
      parameters:
        - in: path
          name: provider
          required: true
          schema:
            type: string
            enum:
              - google
        - in: query
          name: state
          required: true
          schema:
            type: string
        - in: query
          name: code
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Redirect to application with token
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/token/refresh:
    post:
      tags:
        - Auth
      summary: Refresh access token
      description: Get new access token using refresh token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /waitlist:
    post:
      tags:
        - Auth
      summary: Join waitlist
      description: Add email to waitlist
      operationId: joinWaitlist
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WaitlistRequest'
      responses:
        '200':
          description: Added to waitlist
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /webhooks/stripe:
    post:
      tags:
        - Webhooks
      summary: Stripe webhook
      description: Handle Stripe webhook events
      operationId: stripeWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed
        '400':
          description: Invalid webhook
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/me/credits:
    get:
      tags:
        - Credits
      summary: Get user credits
      description: Retrieve current credit balance
      operationId: getCredits
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Credits retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreditsResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /credits/transactions:
    get:
      tags:
        - Credits
      summary: Get credit transactions
      description: List credit transaction history
      operationId: getCreditTransactions
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: page_size
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: direction
          schema:
            type: string
            enum:
              - asc
              - desc
      responses:
        '200':
          description: Transactions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreditTransactionsResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /payments/checkout/subscription:
    post:
      tags:
        - Payments
      summary: Create subscription checkout
      description: Create Stripe checkout session for subscription
      operationId: subscriptionCheckout
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscriptionCheckoutRequest'
      responses:
        '200':
          description: Checkout session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /payments/checkout/topup:
    post:
      tags:
        - Payments
      summary: Create top-up checkout
      description: Create Stripe checkout session for credit top-up
      operationId: topUpCheckout
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TopUpCheckoutRequest'
      responses:
        '200':
          description: Checkout session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /payments/checkout/session/{sessionID}:
    get:
      tags:
        - Payments
      summary: Get checkout session
      description: Retrieve checkout session details
      operationId: getCheckoutSession
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionID'
      responses:
        '200':
          description: Session retrieved successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/story:
    post:
      tags:
        - Workflows
      summary: Create story workflow
      description: Start new story generation workflow
      operationId: createStory
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StoryRequest'
      responses:
        '200':
          description: Story workflow created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/plot:
    post:
      tags:
        - Workflows
      summary: Generate plot
      description: Generate plot for workflow
      operationId: generatePlot
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      responses:
        '200':
          description: Plot generated successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/characters/images:
    post:
      tags:
        - Characters
      summary: Generate character images
      description: Generate images for all characters
      operationId: generateCharacterImages
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      responses:
        '200':
          description: Character images generated
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Assets
      summary: Get character images asset
      description: Retrieve character images asset
      operationId: getCharacterImagesAsset
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - in: query
          name: version
          schema:
            type: integer
      responses:
        '200':
          description: Asset retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowAsset'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/characters/{characterID}/images:
    post:
      tags:
        - Characters
      summary: Regenerate character image
      description: Regenerate image for specific character
      operationId: regenerateCharacterImage
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/CharacterID'
      responses:
        '200':
          description: Character image regenerated
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/characters/{characterID}/images/upload:
    post:
      tags:
        - Characters
      summary: Upload character image
      description: Upload custom image for character
      operationId: uploadCharacterImage
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/CharacterID'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Image uploaded successfully
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Invalid file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/characters/{characterID}/images/history:
    get:
      tags:
        - Characters
      summary: Get character image history
      description: List all image versions for character
      operationId: getCharacterImageHistory
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/CharacterID'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: History retrieved successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/characters:
    post:
      tags:
        - Characters
      summary: Add character
      description: Add new character to workflow
      operationId: addCharacter
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Character added successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/characters/{characterID}:
    delete:
      tags:
        - Characters
      summary: Remove character
      description: Delete character from workflow
      operationId: removeCharacter
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/CharacterID'
      responses:
        '200':
          description: Character removed successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/scenes/images:
    post:
      tags:
        - Scenes
      summary: Generate scene images
      description: Generate images for all scenes
      operationId: generateSceneImages
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      responses:
        '200':
          description: Scene images generated
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Assets
      summary: Get scene images asset
      description: Retrieve scene images asset
      operationId: getSceneImagesAsset
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - in: query
          name: version
          schema:
            type: integer
      responses:
        '200':
          description: Asset retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowAsset'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/scenes/{sceneID}/images:
    post:
      tags:
        - Scenes
      summary: Regenerate scene image
      description: Regenerate image for specific scene
      operationId: regenerateSceneImage
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
      responses:
        '200':
          description: Scene image regenerated
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/scenes/{sceneID}/images/history:
    get:
      tags:
        - Scenes
      summary: Get scene image history
      description: List all image versions for scene
      operationId: getSceneImageHistory
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: History retrieved successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/scenes/{sceneID}/first-frame/images:
    post:
      tags:
        - Scenes
      summary: Generate first frame image
      description: Generate first frame image for scene video
      operationId: generateFirstFrameImage
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
      responses:
        '200':
          description: First frame image generated
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/scenes/{sceneID}/first-frame/images/history:
    get:
      tags:
        - Scenes
      summary: Get first frame image history
      description: List all first frame image versions
      operationId: getFirstFrameImageHistory
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
      responses:
        '200':
          description: History retrieved successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/scenes/{sceneID}/videos/upload:
    post:
      tags:
        - Videos
      summary: Upload scene video
      description: Upload custom video for scene
      operationId: uploadSceneVideo
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Video uploaded successfully
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Invalid file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/scenes/{sceneID}/videos:
    post:
      tags:
        - Videos
      summary: Regenerate scene video
      description: Regenerate video for specific scene
      operationId: regenerateSceneVideo
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/SceneID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - prompt
              properties:
                prompt:
                  type: string
                  description: Motion prompt for video generation
                veo_model:
                  type: string
                  description: Video model (Veo or Sora)
                  enum:
                    - veo-3.1-fast-generate-preview
                    - veo-3.1-generate-preview
                    - sora-2
                    - sora-2-pro
      responses:
        '200':
          description: Video regeneration started
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/videos:
    post:
      tags:
        - Videos
      summary: Generate videos
      description: Generate videos for workflow
      operationId: generateVideos
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                scene_id:
                  type: string
                  description: Optional scene identifier
                veo_model:
                  type: string
                  description: Video model (Veo or Sora)
                  enum:
                    - veo-3.1-fast-generate-preview
                    - veo-3.1-generate-preview
                    - sora-2
                    - sora-2-pro
      responses:
        '200':
          description: Video generation started
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Assets
      summary: Get videos asset
      description: Retrieve videos asset
      operationId: getVideosAsset
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - in: query
          name: version
          schema:
            type: integer
      responses:
        '200':
          description: Asset retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowAsset'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/videos/jobs:
    get:
      tags:
        - Videos
      summary: Get video job history
      description: List video generation jobs for workflow
      operationId: getVideoJobHistory
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Jobs retrieved successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/publish/cover:
    post:
      tags:
        - Workflows
      summary: Publish cover
      description: Publish workflow cover image
      operationId: publishCover
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Cover published successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/publish:
    post:
      tags:
        - Workflows
      summary: Publish workflow
      description: Publish complete workflow
      operationId: publishWorkflow
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      responses:
        '200':
          description: Workflow published successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Assets
      summary: Get publish asset
      description: Retrieve publish asset
      operationId: getPublishAsset
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - in: query
          name: version
          schema:
            type: integer
      responses:
        '200':
          description: Asset retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowAsset'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/chapters:
    post:
      tags:
        - Workflows
      summary: Add chapter
      description: Add new chapter to workflow
      operationId: addChapter
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Chapter added successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/chapters/{chapterID}:
    delete:
      tags:
        - Workflows
      summary: Remove chapter
      description: Delete chapter from workflow
      operationId: removeChapter
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/ChapterID'
      responses:
        '200':
          description: Chapter removed successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/chapters/{chapterID}/scenes:
    post:
      tags:
        - Workflows
      summary: Add scene
      description: Add new scene to chapter
      operationId: addScene
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/ChapterID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Scene added successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/chapters/{chapterID}/scenes/{sceneID}:
    delete:
      tags:
        - Workflows
      summary: Remove scene
      description: Delete scene from chapter
      operationId: removeScene
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/ChapterID'
        - $ref: '#/components/parameters/SceneID'
      responses:
        '200':
          description: Scene removed successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      tags:
        - Workflows
      summary: Update scene
      description: |
        Update scene content including description, image prompts, transition logic, character assignments, and QTE configuration.
        All fields are optional - only provide the fields you want to update.
      operationId: updateScene
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/ChapterID'
        - $ref: '#/components/parameters/SceneID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScenePatchRequest'
            examples:
              basic_update:
                summary: Update scene description
                value:
                  description: "A dark and mysterious forest path"
                  short_introduction: "The hero enters the forest"
              full_update:
                summary: Complete scene update
                value:
                  scene_id: "forest_1"
                  short_introduction: "Entering the enchanted forest"
                  description: "A winding path through ancient trees"
                  image_prompt_params:
                    description_prompt: "Dark forest with mystical lighting"
                    visual_style: "cinematic"
                    ratio: "16:9"
                  video_motion_prompt: "Camera slowly pans through the forest"
                  transition_logic:
                    type: "branching"
                    details:
                      options:
                        - text: "Take the left path"
                          next_scene: "forest_left"
                        - text: "Take the right path"
                          next_scene: "forest_right"
                  character_ids: ["hero", "guide"]
                  qte:
                    type: "choice"
                    next_node_map:
                      "1": "scene_success"
                      "-1": "scene_failure"
      responses:
        '200':
          description: Scene updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowAsset'
        '400':
          description: Invalid request (e.g., invalid QTE next_node_map keys)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow, chapter, or scene not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/story/summary:
    patch:
      tags:
        - Workflows
      summary: Update story summary
      description: Update workflow story summary
      operationId: updateStorySummary
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Summary updated successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/assets/{assetType}/versions:
    get:
      tags:
        - Assets
      summary: List asset versions
      description: Get all versions of a specific asset type
      operationId: listAssetVersions
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/AssetType'
      responses:
        '200':
          description: Asset versions retrieved
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/assets/{assetType}/selection:
    patch:
      tags:
        - Assets
      summary: Select asset version
      description: Set the active version for an asset type
      operationId: selectAssetVersion
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - $ref: '#/components/parameters/AssetType'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Asset version selected
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}:
    get:
      tags:
        - Workflows
      summary: Get workflow
      description: Retrieve workflow details
      operationId: getWorkflow
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
      responses:
        '200':
          description: Workflow retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workflow'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Workflow not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows:
    get:
      tags:
        - Workflows
      summary: List workflows
      description: Get all user workflows
      operationId: listWorkflows
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: Workflows retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowListResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /video-jobs/{jobID}:
    get:
      tags:
        - Videos
      summary: Get video job status
      description: Retrieve status of video generation job
      operationId: getVideoJobStatus
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/JobID'
      responses:
        '200':
          description: Job status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VideoJob'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/story:
    get:
      tags:
        - Assets
      summary: Get story asset
      description: Retrieve story asset for workflow
      operationId: getStoryAsset
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - in: query
          name: version
          schema:
            type: integer
      responses:
        '200':
          description: Asset retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowAsset'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/plot:
    get:
      tags:
        - Assets
      summary: Get plot asset
      description: Retrieve plot asset for workflow
      operationId: getPlotAsset
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - in: query
          name: version
          schema:
            type: integer
      responses:
        '200':
          description: Asset retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowAsset'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/first-frame/images:
    get:
      tags:
        - Assets
      summary: Get first frame images asset
      description: Retrieve first frame images asset
      operationId: getFirstFrameImagesAsset
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - in: query
          name: version
          schema:
            type: integer
      responses:
        '200':
          description: Asset retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowAsset'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /workflows/{workflowID}/status:
    get:
      tags:
        - Workflows
      summary: Get workflow status
      description: Retrieve workflow status and progress
      operationId: getWorkflowStatus
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkflowID'
        - in: query
          name: async
          schema:
            type: boolean
      responses:
        '200':
          description: Status retrieved successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/invite-codes:
    post:
      tags:
        - Admin
      summary: Create invite code
      description: Create new invite code
      operationId: createInviteCode
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInviteCodeRequest'
      responses:
        '200':
          description: Invite code created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InviteCode'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Admin
      summary: List invite codes
      description: Get all invite codes
      operationId: listInviteCodes
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: Invite codes retrieved
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/invite-codes/{inviteCodeID}:
    get:
      tags:
        - Admin
      summary: Get invite code
      description: Retrieve invite code details
      operationId: getInviteCode
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/InviteCodeID'
      responses:
        '200':
          description: Invite code retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InviteCode'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Invite code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      tags:
        - Admin
      summary: Update invite code
      description: Update invite code details
      operationId: updateInviteCode
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/InviteCodeID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateInviteCodeRequest'
      responses:
        '200':
          description: Invite code updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InviteCode'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/waitlist:
    get:
      tags:
        - Admin
      summary: List waitlist
      description: Get all waitlist entries
      operationId: listWaitlist
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/WaitlistStatus'
      responses:
        '200':
          description: Waitlist retrieved
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /debug/text-llm/config:
    get:
      tags:
        - Debug
      summary: Get text LLM config
      description: Retrieve text LLM configuration
      operationId: getTextLLMConfig
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Config retrieved
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /debug/text-llm/invoke:
    post:
      tags:
        - Debug
      summary: Invoke text LLM
      description: Directly invoke text LLM for debugging
      operationId: invokeTextLLM
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: LLM invoked successfully
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /debug/text-llm/history:
    get:
      tags:
        - Debug
      summary: Get text LLM history
      description: Retrieve text LLM invocation history
      operationId: getTextLLMHistory
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: History retrieved
          content:
            application/json:
              schema:
                type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /mock/users/{userID}/subscription:
    post:
      tags:
        - Mock
      summary: Mock subscription
      description: Create mock subscription for testing
      operationId: mockSubscription
      parameters:
        - $ref: '#/components/parameters/UserID'
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Mock subscription created
          content:
            application/json:
              schema:
                type: object

  /mock/users/{userID}/booster:
    post:
      tags:
        - Mock
      summary: Mock booster
      description: Create mock booster for testing
      operationId: mockBooster
      parameters:
        - $ref: '#/components/parameters/UserID'
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Mock booster created
          content:
            application/json:
              schema:
                type: object
